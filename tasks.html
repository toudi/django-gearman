

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tasks &mdash; django-gearman 0.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="django-gearman 0.4 documentation" href="index.html" />
    <link rel="next" title="Task queues" href="queues.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="queues.html" title="Task queues"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">django-gearman 0.4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tasks">
<h1>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h1>
<div class="section" id="registering-jobs">
<h2>Registering jobs<a class="headerlink" href="#registering-jobs" title="Permalink to this headline">¶</a></h2>
<p>Create a file <cite>gearman_jobs.py</cite> in any of your django apps, and define as many
jobs as functions as you like. The jobs must return the result of the operation,
if applicable.</p>
<p>Mark each of these functions as gearman jobs by decorating them with
<cite>django_gearman.decorators.gearman_job</cite>.</p>
<p>For an example, look at the <cite>gearman_example</cite> app&#8217;s <cite>gearman_jobs.py</cite> file.</p>
<div class="section" id="job-naming">
<h3>Job naming<a class="headerlink" href="#job-naming" title="Permalink to this headline">¶</a></h3>
<p>The tasks are given a default name of their import path, with the phrase
&#8216;gearman_jobs&#8217; stripped out of them, for readability reasons. You can override
the task name by specifying <cite>name</cite> parameter of the decorator. Here&#8217;s how:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@gearman_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;my-task-name&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_task_function</span><span class="p">(</span><span class="n">foo</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="gearman-internal-job-naming-gearman-job-name">
<h3>Gearman-internal job naming: <tt class="docutils literal"><span class="pre">GEARMAN_JOB_NAME</span></tt><a class="headerlink" href="#gearman-internal-job-naming-gearman-job-name" title="Permalink to this headline">¶</a></h3>
<p>The setting <tt class="docutils literal"><span class="pre">GEARMAN_JOB_NAME</span></tt> is a function which takes the original task
name as an argument and returns the gearman-internal version of that task
name. This allows you to map easily usable names in your application to more
complex, unique ones inside gearman.</p>
<p>The default behavior of this method is as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">new_task_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="n">getcwd</span><span class="p">()),</span> <span class="n">task_name</span><span class="p">)</span>
</pre></div>
</div>
<p>This way several instances of the same application can be run on the same
server. You may want to change it if you have several, independent instances
of the same application run against a shared gearman server.</p>
<p>If you would like to change this behavior, simply define the
<tt class="docutils literal"><span class="pre">GEARMAN_JOB_NAME</span></tt> function in the <tt class="docutils literal"><span class="pre">settings.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">GEARMAN_JOB_NAME</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span>
</pre></div>
</div>
<p>which would leave the internal task name unchanged.</p>
</div>
</div>
<div class="section" id="task-parameters">
<h2>Task parameters<a class="headerlink" href="#task-parameters" title="Permalink to this headline">¶</a></h2>
<p>The gearman docs specify that the job function can accept only one parameter
(usually refered to as the <tt class="docutils literal"><span class="pre">data</span></tt> parameter). Additionally, that parameter
may only be a string. Sometimes that may not be enough. What if you would like
to pass an array or a dict? You would need to serialize and deserialize them.
Fortunately, django-gearman can take care of this, so that you can spend
all of your time on coding the actual task.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@gearman_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;my-task-name&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_task_function</span><span class="p">(</span><span class="n">foo</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;becomes&#39;</span><span class="p">,</span> <span class="s">&#39;this&#39;</span><span class="p">:</span> <span class="s">&#39;dict&#39;</span><span class="p">})</span>
<span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="tasks-with-more-than-one-parameter">
<h3>Tasks with more than one parameter<a class="headerlink" href="#tasks-with-more-than-one-parameter" title="Permalink to this headline">¶</a></h3>
<p>You can pass as many arguments as you want, of whatever (serializable) type
you like. Here&#8217;s an example job definition</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@gearman_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;my-task-name&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_task_function</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">three</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>You can execute this function in two different ways</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">two</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">three</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p>Unfortunately, executing it like this</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>would produce the error, because <cite>submit_job</cite> from Gearman&#8217;s Python bindings
contains <strong>a lot</strong> of arguments and it&#8217;s much easier to specify them via
keyword names or a special <tt class="docutils literal"><span class="pre">args</span></tt> keyword than to type something like seven
<a href="#id1"><span class="problematic" id="id2">``</span></a>None``s instead</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>The only limitation that you have are gearman reserved keyword parameters. As of
Gearman 2.0.2 these are:</p>
<blockquote>
<div><ul class="simple">
<li>data</li>
<li>unique</li>
<li>priority</li>
<li>background</li>
<li>wait_until_complete</li>
<li>max_retries</li>
<li>poll_timeout</li>
</ul>
</div></blockquote>
<p>So, if you want your job definition to have, for example, <tt class="docutils literal"><span class="pre">unique</span></tt> or
<tt class="docutils literal"><span class="pre">background</span></tt> keyword parameters, you need to execute the job in a special,
more verbose way. Here&#8217;s an example of such a job and its execution.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@gearman_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;my-task-name&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_task_function</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">unique</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;background&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;unique&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
<span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span>
</pre></div>
</div>
<p>Finally</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">client</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="s">&#39;my-task-name&#39;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;background&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&quot;unique&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
</pre></div>
</div>
<p>Don&#8217;t panic, your task is safe! That&#8217;s because you&#8217;re using <tt class="docutils literal"><span class="pre">kwargs</span></tt>
directly. Therefore, Gearman&#8217;s bindings would receive <tt class="docutils literal"><span class="pre">True</span></tt> for
<tt class="docutils literal"><span class="pre">submit_job</span></tt> function, while your task would receive <tt class="docutils literal"><span class="pre">False</span></tt>.</p>
<p>Always remember to double-check your parameter names with the reserved words
list.</p>
</div>
</div>
<div class="section" id="starting-worker-s">
<h2>Starting worker(s)<a class="headerlink" href="#starting-worker-s" title="Permalink to this headline">¶</a></h2>
<p>To start a worker, run <cite>python manage.py gearman_worker</cite>. It will start
serving all registered jobs.</p>
<p>To spawn more than one worker (if, e.g., most of your jobs are I/O bound),
use the <cite>-w</cite> option</p>
<div class="highlight-python"><pre>python manage.py gearman_worker -w 5</pre>
</div>
<p>will start five workers.</p>
<p>Since the process will keep running while waiting for and executing jobs,
you probably want to run this in a <cite>screen</cite> session or similar.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tasks</a><ul>
<li><a class="reference internal" href="#registering-jobs">Registering jobs</a><ul>
<li><a class="reference internal" href="#job-naming">Job naming</a></li>
<li><a class="reference internal" href="#gearman-internal-job-naming-gearman-job-name">Gearman-internal job naming: <tt class="docutils literal"><span class="pre">GEARMAN_JOB_NAME</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-parameters">Task parameters</a><ul>
<li><a class="reference internal" href="#tasks-with-more-than-one-parameter">Tasks with more than one parameter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#starting-worker-s">Starting worker(s)</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installation.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="queues.html"
                        title="next chapter">Task queues</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tasks.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="queues.html" title="Task queues"
             >next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             >previous</a> |</li>
        <li><a href="index.html">django-gearman 0.4 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Frederic Wenzel &lt;fwenzel@mozilla.com&gt;, Mateusz Mikołajczyk &lt;mikolajczyk.mateusz@gmail.com&gt;.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>